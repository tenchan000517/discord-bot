# ポイント消費機能 要件定義書

## 1. 概要
ユーザーが保持するポイントを消費するための機能を実装する。管理者の承認を必要とするポイント消費システムを構築する。

## 2. 機能要件

### 2.1 基本機能
1. パネル表示機能
   - 指定のチャンネルにパネルを表示
   - パネル上にポイント消費ボタンを配置

2. ポイント消費フロー
   - ユーザーがボタンをクリック
   - 管理者へ通知
   - 管理者による承認/キャンセル
   - ポイントの消費処理
   - 結果通知

3. ログ機能
   - 指定チャンネルへのログ記録
   - アクションごとのログ設定

### 2.2 管理者設定項目
1. パネル設定
   - ボタンの表示名
   - 表示チャンネル
   - 必要ポイント数

2. 通知設定
   - 通知チャンネル
   - メンションロール（複数可）

3. 承認UI設定
   - スレッド使用有無
   - スレッド作成 or 専用ボタン表示

4. メッセージ設定
   - 完了メッセージの表示有無

5. ログ設定
   - ログ機能の有効/無効
   - ログチャンネル
   - 記録するアクション種別
     - 消費ボタンクリック
     - 完了およびポイント消費
     - キャンセル
     - 全て

## 3. データベース設計

### 3.1 新規テーブル: point_consumption_history
```
- PK: server_id (String)
- SK: timestamp (String)
- user_id (String)
- amount (Number)
- status (String: 'pending'|'completed'|'cancelled')
- thread_id (String, optional)
- admin_id (String)
- created_at (String)
- updated_at (String)
```

### 3.2 既存テーブル拡張: server_settings
```
feature_settings:
  point_consumption:
    enabled: Boolean
    button_name: String
    channel_id: String
    notification_channel_id: String
    mention_role_ids: String[]
    use_thread: Boolean
    completion_message_enabled: Boolean
    logging_enabled: Boolean
    logging_channel_id: String
    logging_actions: String[]
```

## 4. 権限要件
1. ポイント消費機能の利用
   - すべてのユーザー

2. 承認/キャンセル操作
   - 管理者権限を持つユーザーのみ

3. 設定変更
   - 管理者権限を持つユーザーのみ

## 5. エラーハンドリング
1. ポイント不足
2. チャンネル未設定
3. ロール/権限不足
4. データベース操作失敗
5. Discord API通信エラー

## 6. 制約事項
- 既存機能を変更しない
- 既存のデータ構造を維持
- バックワードコンパティビリティの確保

## 7. パフォーマンス要件
- ボタンクリックからの応答: 3秒以内
- データベース操作: 5秒以内
- Discord API通信: 3秒以内

## 8. セキュリティ要件
- ユーザー認証の確実な実施
- 管理者権限の適切な確認
- ポイント操作の二重実行防止
- センシティブなデータの適切な保護


実装手順

1. ポイント消費機能の実装

```
discord-gacha-bot/
├── cogs/
│   ├── points_consumption.py (新規作成: ポイント消費機能のコグ)
│   └── admin.py (既存修正: 管理者設定コマンドの追加)
│
├── models/
│   └── server_settings.py (既存修正: 消費関連設定の追加)
│
├── utils/
│   ├── aws_database.py (既存修正: 消費履歴テーブル操作の追加)
│   ├── point_manager.py (既存修正: ポイント消費メソッドの追加)
│   └── settings_manager.py (既存修正: 消費設定の管理追加)
│
├── dashboard/
│   └── src/
│       ├── components/
│       │   ├── EditForms/
│       │   │   └── PointConsumptionSettingsForm.js (新規作成)
│       │   └── ServerDashboard/
│       │       └── FeatureSettings.js (既存修正)
│       │
│       ├── utils/
│       │   └── aws.js (既存修正)
│       │
│       └── app/
│           └── api/
│               └── servers/
│                   └── [id]/
│                       └── points/
│                           └── consumption/
│                               └── route.js (新規作成)
```

2. データベース修正点：
```
DynamoDB新規テーブル:
- point_consumption_history:
  - PK: server_id (String)
  - SK: timestamp (String)
  - user_id (String)
  - amount (Number)
  - status (String: 'pending'|'completed'|'cancelled')
  - thread_id (String - オプション)
  - admin_id (String - 承認者ID)
  - created_at (String)
  - updated_at (String)
```

3. サーバー設定追加項目(server_settings.py):
```python
@dataclass
class PointConsumptionSettings:
    enabled: bool = True
    button_name: str = "ポイント消費"
    channel_id: str = None
    notification_channel_id: str = None
    mention_role_ids: List[str] = None
    use_thread: bool = False
    completion_message_enabled: bool = True
    logging_enabled: bool = False
    logging_channel_id: str = None
    logging_actions: List[str] = None  # ['click', 'complete', 'cancel', 'all']
```

この構造で、要件に挙げられた全ての機能を実装可能です：
- パネルとボタンの設置
- 管理者による各種設定
- 通知システム
- 承認フロー
- ログ機能


ご要件を整理し、修正計画を作成いたします。

核となる要件:
1. ポイントの統合
- 個別カテゴリ（gacha, battle等）のポイントを廃止し、単一の合計ポイントのみを管理
- 常に上書きで更新

2. ポイント履歴の通知システム
- 獲得履歴（誰が何で何ポイント獲得）
- 消費履歴（誰が何で何ポイント消費）
- 通知チャンネルの個別設定
- 通知のON/OFF設定

修正計画:

1. `models/server_settings.py`の修正
```
A. GlobalSettingsクラスに以下を追加:
- point_history_settings: {
    gain_notification_enabled: bool
    gain_notification_channel: Optional[str]
    consumption_notification_enabled: bool
    consumption_notification_channel: Optional[str]
}
```

2. `utils/aws_database.py`の修正
```
A. update_feature_pointsメソッドの改修:
- 個別ポイント保存を廃止
- totalポイントのみを更新
- pointsフィールドを単一の数値に変更

B. get_user_pointsメソッドの改修:
- feature引数を削除
- 単一のポイント値のみを返すように変更
```

3. `utils/point_manager.py`の修正
```
A. update_pointsメソッドの改修:
- feature引数を削除
- 履歴通知機能の追加:
  - _notify_point_gainメソッドの追加
  - _notify_point_consumptionメソッドの追加

B. consume_pointsメソッドの改修:
- ポイント消費時の通知処理追加
```

4. `cogs/gacha.py`の修正
```
A. ガチャ実行時のポイント処理修正:
- feature='gacha'の指定を削除
- ポイント獲得通知の追加
```

5. `cogs/battle.py`の修正
```
A. バトル報酬のポイント処理修正:
- feature='battle'の指定を削除
- ポイント獲得通知の追加
```

6. `cogs/points_consumption.py`の修正
```
A. ポイント消費処理の修正:
- 消費通知の追加
```

実装の優先順位:
1. server_settings.pyの修正（設定基盤）
2. aws_database.pyの修正（データ構造の変更）
3. point_manager.pyの修正（ポイント処理の中核）
4. 各cogの修正（実際の機能実装）

この修正により:
- すべてのポイントが単一の値として管理される
- ポイントの増減がすべて指定チャンネルに通知される
- サーバー管理者が通知設定を柔軟に行える

実装を開始してよろしいでしょうか？