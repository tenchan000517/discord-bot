# Discord Bot プロジェクト仕様書

## 目次
1. [プロジェクト概要](#プロジェクト概要)
2. [システム構成](#システム構成)
3. [機能仕様](#機能仕様)
4. [技術仕様](#技術仕様)
5. [ファイル構造](#ファイル構造)
6. [データベース設計](#データベース設計)
7. [セキュリティ仕様](#セキュリティ仕様)
8. [運用仕様](#運用仕様)

## プロジェクト概要

### 目的
- Discordサーバー上でガチャシステムを提供するボットの実装
- ユーザーエンゲージメントの向上
- サーバー管理者によるカスタマイズ可能なガチャシステムの提供

### 主要機能
- ガチャの実行
- ポイントシステム
- カスタマイズ可能なアイテム設定
- 管理者用設定コマンド

## システム構成

### インフラストラクチャ
- **実行環境**: AWS EC2 (Amazon Linux 2023)
- **データストア**: AWS DynamoDB
- **デプロイ方式**: systemdによる永続化

### 依存関係
- Python 3.9
- discord.py
- boto3
- python-dotenv
- pytz

## 機能仕様

### 1. ガチャシステム
#### 基本機能
- `!gacha`: ガチャを実行するコマンド
- レアリティ別の排出率設定
- ポイント獲得システム

#### アイテム設定
- SSR, SR, R, Nの4段階レアリティ
- カスタマイズ可能な排出率
- アイテムごとのポイント設定

### 2. 管理機能
#### サーバー設定
- アイテムの追加/編集/削除
- 排出率の調整
- ポイント設定の変更

#### ユーザー管理
- ユーザーごとのポイント管理
- ガチャ履歴の記録

## 技術仕様

### アプリケーション構造
```
discord-bot/
├── main.py             # メインエントリーポイント
├── cogs/              # コマンド機能モジュール
│   └── gacha.py       # ガチャ関連コマンド
├── utils/             # ユーティリティ
│   └── aws_database.py # AWS関連機能
└── .env               # 環境変数
```

### クラス構造

#### GachaBot (main.py)
```python
class GachaBot(commands.Bot):
    def __init__(self)
    async def setup_hook()
    async def on_ready()
```

#### AWSDatabase (aws_database.py)
```python
class AWSDatabase:
    def __init__(self)
    def get_server_settings()
    def update_server_settings()
    def get_user_points()
    def update_user_points()
```

## データベース設計

### DynamoDB テーブル構造

#### ServerSettings テーブル
- **パーティションキー**: server_id (String)
- **属性**:
  - settings (Map)
    - items (List)
      - name (String)
      - weight (Number)
      - image_url (String)
      - points (Number)
  - updated_at (String)

#### UserPoints テーブル
- **パーティションキー**: user_id (String)
- **ソートキー**: server_id (String)
- **属性**:
  - points (Number)
  - last_gacha (String)
  - total_gachas (Number)

## セキュリティ仕様

### 認証・認可
- Discord Bot Token認証
- AWS IAMロールベースのアクセス制御
- 環境変数による機密情報管理

### データ保護
- AWS KMSによる暗号化
- セキュアな環境変数管理
- 最小権限の原則に基づくIAMポリシー

## 運用仕様

### 監視項目
- サービス稼働状態
- ログ監視
- DynamoDBのキャパシティ使用状況

### バックアップ
- 環境変数のバックアップ
- データベースバックアップ（DynamoDB自動バックアップ）

### ログ管理
- アプリケーションログ: `/var/log/discord-bot/discord.log`
- エラーログ: `/var/log/discord-bot/discord.error.log`
- システムログ: journalctl経由

### メンテナンス手順
1. コード更新
   ```bash
   git pull origin main
   sudo systemctl restart discord-bot
   ```

2. 依存関係更新
   ```bash
   source venv/bin/activate
   pip install -r requirements.txt
   ```

3. 設定変更
   ```bash
   nano .env
   sudo systemctl restart discord-bot
   ```

## 開発ガイドライン

### コーディング規約
- PEP 8準拠
- Docstring必須
- 型ヒントの使用推奨

### Git運用ルール
- ブランチ命名規則: `feature/`, `bugfix/`, `hotfix/`
- コミットメッセージ規約: 
  - 追加: `feat:`
  - 修正: `fix:`
  - リファクタリング: `refactor:`

### テスト要件
- ユニットテストの作成
- 結合テストの実施
- デプロイ前の動作確認

## 今後の展開

### 予定機能
1. マルチサーバー対応の強化
2. ガチャアニメーションの実装
3. ユーザーランキングシステム
4. 定期的なイベントシステム

### 検討中の改善点
- パフォーマンス最適化
- UIの改善
- 管理機能の拡充
- 統計機能の追加

## 付録

### 用語集
- **ガチャ**: ランダムなアイテム取得システム
- **レアリティ**: アイテムの希少度（SSR, SR, R, N）
- **ポイント**: ユーザーが獲得できる報酬単位

### 参考リンク
- [Discord Developer Portal](https://discord.com/developers/docs)
- [discord.py Documentation](https://discordpy.readthedocs.io/)
- [AWS Documentation](https://docs.aws.amazon.com/)

### 更新履歴
- 2024-12-07: 初版作成
- 2024-12-07: AWSデータベース機能の追加
- 2024-12-07: systemdによる永続化対応