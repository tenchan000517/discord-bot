```
discord-gacha-bot/
├── main.py
    # メインアプリケーションエントリーポイント
    # - CustomBot クラスの定義と初期化
    # - インテントの設定（messages, members, guilds 必須）
    # - スラッシュコマンドの同期処理
    # - エラーハンドリングの実装
    # - 環境変数のロード
    # - データベース接続の初期化
    # - すべての Cogs の自動読み込み処理

├── config/
│   ├── __init__.py
│   ├── settings.py
│   │   # アプリケーション設定の一元管理
│   │   # - 環境変数の定義と読み込み（.env対応）
│   │   # - データベース接続設定
│   │   # - Discord Bot トークン設定
│   │   # - Web3プロバイダー設定
│   │   # - その他のAPI設定
│   │
│   └── constants.py
│       # 定数定義
│       # - ロール名定義
│       # - コマンド名定義
│       # - エラーメッセージ定義
│       # - 固定値の定義（手数料、制限値など）
│       # - カラーコード定義

├── cogs/
│   ├── __init__.py
│   ├── gacha.py
│   │   # ガチャ機能の実装
│   │   # - スラッシュコマンド: /gacha, /gacha_settings
│   │   # - DynamoDBとの連携
│   │   # - ポイント管理システム
│   │   # - ロール付与システム
│   │
│   ├── wallet.py
│   │   # ウォレット機能の実装
│   │   # - スラッシュコマンド: /connect_wallet, /disconnect_wallet, /balance
│   │   # - Web3との連携（wallet_service.pyを使用）
│   │   # - ウォレット認証システム
│   │   # - トランザクション履歴表示
│   │
│   ├── rumble.py
│   │   # ランブル機能の実装
│   │   # - スラッシュコマンド: /start_rumble, /join_rumble, /leave_rumble
│   │   # - マッチメイキングシステム
│   │   # - チーム管理システム
│   │   # - スコア計算システム
│   │
│   ├── fortunes.py
│   │   # 占い機能の実装
│   │   # - スラッシュコマンド: /fortune, /daily_fortune
│   │   # - 占い結果の生成ロジック
│   │   # - 日次リセットシステム
│   │
│   ├── nft.py
│   │   # NFT関連機能の実装
│   │   # - スラッシュコマンド: /mint_nft, /view_collection, /transfer_nft
│   │   # - NFTミント処理（nft_service.pyを使用）
│   │   # - コレクション表示機能
│   │   # - 転送機能
│   │
│   └── survey.py
│       # アンケート機能の実装
│       # - スラッシュコマンド: /create_survey, /vote, /view_results
│       # - 投票システム（Viewsクラスの使用）
│       # - 結果集計機能
│       # - グラフ生成機能

├── services/
│   ├── __init__.py
│   ├── wallet_service.py
│   │   # ウォレット関連のビジネスロジック
│   │   # - Web3 Provider初期化
│   │   # - ウォレット接続検証
│   │   # - トランザクション処理
│   │   # - 残高確認機能
│   │
│   ├── nft_service.py
│   │   # NFT関連のビジネスロジック
│   │   # - スマートコントラクト連携
│   │   # - NFTミント処理
│   │   # - メタデータ管理
│   │   # - IPFS連携
│   │
│   └── blockchain_service.py
│       # ブロックチェーン関連の共通処理
│       # - トランザクション署名
│       # - ガス料金計算
│       # - チェーン接続管理
│       # - イベントリスナー

├── utils/
│   ├── __init__.py
│   ├── aws_database.py
│   │   # AWS DynamoDB操作クラス
│   │   # - テーブル定義
│   │   # - CRUD操作の実装
│   │   # - クエリビルダー
│   │
│   ├── mongo_database.py
│   │   # MongoDB操作クラス
│   │   # - スキーマ定義
│   │   # - CRUD操作の実装
│   │   # - インデックス管理
│   │
│   └── helpers.py
│       # 共通ユーティリティ関数
│       # - 日付操作関数
│       # - 文字列処理関数
│       # - エラーハンドリング関数
│       # - ログ出力関数

├── models/
│   ├── __init__.py
│   ├── user.py
│   │   # ユーザーモデル定義
│   │   # - ユーザー情報構造
│   │   # - バリデーションルール
│   │   # - ポイント計算メソッド
│   │
│   ├── wallet.py
│   │   # ウォレットモデル定義
│   │   # - ウォレット情報構造
│   │   # - 認証状態管理
│   │   # - トランザクション履歴
│   │
│   └── nft.py
│       # NFTモデル定義
│       # - NFTメタデータ構造
│       # - 所有権情報
│       # - トークン情報

└── tests/
    ├── __init__.py
    ├── test_gacha.py
    │   # ガチャ機能のテスト
    │   # - ガチャ実行テスト
    │   # - ポイント計算テスト
    │   # - データベース操作テスト
    │
    └── test_wallet.py
        # ウォレット機能のテスト
        # - ウォレット接続テスト
        # - トランザクションテスト
        # - 残高確認テスト

# 主要な連携ポイント
1. main.py は config/settings.py から設定を読み込み
2. 各Cogは対応するserviceを使用（wallet.py → wallet_service.py）
3. すべてのデータベース操作はutils/のデータベースクラスを経由
4. モデルはservicesとCogsの両方で使用
5. テストは各機能の単体テストを実装

# データベース設計
- DynamoDB: ユーザーデータ、ガチャ履歴
- MongoDB: NFT所有情報、ランブル履歴

# エラーハンドリング方針
- すべての外部API呼び出しはtry-catch
- ユーザーへのエラー表示は統一フォーマット
- エラーログはCloudWatchに転送

```
discord-gacha-bot/
├── main.py
    # === 追加実装要件 ===
    # 1. グローバルエラーハンドラーの実装
    #    - discord.on_error のオーバーライド
    #    - Cogでキャッチできなかったエラーの処理
    # 2. カスタムBot拡張
    #    - サーバー設定のキャッシュ機構
    #    - グローバルクールダウン管理
    # 3. 起動時の整合性チェック
    #    - 必要なロールの存在確認
    #    - データベース接続テスト
    #    - 環境変数の検証

├── config/
│   ├── settings.py
│   │   # === 追加実装要件 ===
│   │   # 1. 環境変数のバリデーション
│   │   # 2. 階層化された設定構造
│   │   #    server_settings:
│   │   #      roles:
│   │   #        reward_roles: {...}
│   │   #        permission_roles: {...}
│   │   #      commands:
│   │   #        enabled: [...]
│   │   #        disabled: [...]
│   │   # 3. 設定の自動リロード機能
│   │
│   └── constants.py
│       # === 追加実装要件 ===
│       # 1. ロール階層の定義
│       #    ROLE_HIERARCHY = {
│       #      'admin': ['manage_server'],
│       #      'moderator': ['manage_messages']
│       #    }
│       # 2. 機能ごとの権限マップ
│       # 3. エラーコードとメッセージのマッピング

├── models/
│   ├── server_settings.py  # 新規追加
│   │   # === 実装要件 ===
│   │   # 1. サーバー固有設定のモデル
│   │   # 2. 設定のバリデーションルール
│   │   # 3. デフォルト値の定義
│   │   # 4. 設定の継承関係
│   │
│   └── role_settings.py  # 新規追加
│       # === 実装要件 ===
│       # 1. ロール設定のモデル
│       # 2. ロール付与条件の定義
│       # 3. ロール間の依存関係管理

├── utils/
│   ├── aws_database.py
│   │   # === 追加実装要件 ===
│   │   # 1. サーバー設定用のテーブル定義
│   │   #    - server_settings
│   │   #      - PK: server_id
│   │   #      - SK: setting_type
│   │   # 2. 設定の更新履歴管理
│   │   # 3. 設定の一括更新機能
│   │
│   └── role_manager.py  # 新規追加
│       # === 実装要件 ===
│       # 1. ロール操作のユーティリティ
│       # 2. ロールの存在確認
│       # 3. ロールの階層チェック
│       # 4. ロールの権限検証

├── cogs/
│   ├── server_settings.py  # 新規追加
│   │   # === 実装要件 ===
│   │   # 1. 設定管理コマンド
│   │   #    - /settings view
│   │   #    - /settings edit
│   │   #    - /settings reset
│   │   # 2. 設定UIの実装
│   │   # 3. 権限チェック
│   │
│   └── role_manager.py  # 新規追加
│       # === 実装要件 ===
│       # 1. ロール管理コマンド
│       #    - /roles setup
│       #    - /roles edit
│       #    - /roles view
│       # 2. ロール付与条件の設定
│       # 3. ロール権限の管理

# === データベース設計の詳細 ===
# DynamoDB Tables:
# 1. server_settings
#    - PK: server_id (STRING)
#    - SK: setting_type (STRING) // 'roles', 'commands', etc.
#    - settings: (MAP) // 実際の設定値
#    - updated_at: (STRING)
#    - updated_by: (STRING)
#
# 2. role_settings
#    - PK: server_id#role_id (STRING)
#    - conditions: (MAP) // 付与条件
#    - permissions: (LIST) // 権限リスト
#    - hierarchy_level: (NUMBER)
#    - created_at: (STRING)

# === エラーハンドリングの詳細 ===
# 1. カスタムエラークラス
#    - ServerSettingsError
#    - RoleManagementError
#    - PermissionError
#
# 2. エラーレスポンス形式
#    {
#      "error": {
#        "code": "ERR_CODE",
#        "message": "User friendly message",
#        "details": {...}
#      }
#    }

# === 権限システムの実装 ===
# 1. 階層型権限システム
#    - Server Owner
#    - Admin
#    - Moderator
#    - User
#
# 2. 機能別権限
#    - ガチャ管理
#    - ロール管理
#    - 設定管理

discord-gacha-bot/
├── main.py
├── config/
│   ├── __init__.py
│   ├── settings.py
│   └── constants.py
├── core/  # 新規追加: コアシステム機能
│   ├── __init__.py
│   ├── bot.py          # カスタムBotクラスの実装
│   ├── cache.py        # キャッシュ管理システム
│   ├── permissions.py  # 権限システム
│   └── exceptions.py   # カスタム例外クラス
├── cogs/
│   ├── __init__.py
│   ├── admin/  # 新規追加: 管理機能
│   │   ├── __init__.py
│   │   ├── server_settings.py
│   │   └── role_manager.py
│   ├── gacha.py
│   ├── wallet.py
│   ├── rumble.py
│   ├── fortunes.py
│   ├── nft.py
│   └── survey.py
├── services/
│   ├── __init__.py
│   ├── settings/  # 新規追加: 設定関連サービス
│   │   ├── __init__.py
│   │   ├── server_settings_service.py
│   │   └── role_settings_service.py
│   ├── wallet_service.py
│   ├── nft_service.py
│   └── blockchain_service.py
├── utils/
│   ├── __init__.py
│   ├── aws_database.py
│   ├── mongo_database.py
│   ├── role_manager.py  # 新規追加
│   └── helpers.py
├── models/
│   ├── __init__.py
│   ├── user.py
│   ├── wallet.py
│   ├── nft.py
│   ├── server_settings.py  # 新規追加
│   └── role_settings.py   # 新規追加
└── tests/
    ├── __init__.py
    ├── test_gacha.py
    ├── test_wallet.py
    ├── test_server_settings.py  # 新規追加
    └── test_role_manager.py     # 新規追加