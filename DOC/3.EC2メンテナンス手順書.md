# Discord Bot デプロイメントガイド

## 目次
1. [事前準備](#事前準備)
2. [初期セットアップ](#初期セットアップ)
3. [デプロイ手順](#デプロイ手順)
4. [メンテナンス手順](#メンテナンス手順)
5. [トラブルシューティング](#トラブルシューティング)

## 事前準備

### 必要なアカウントと認証情報
- GitHubアカウント
- Discord Botトークン
- AWSアクセスキーとシークレットキー

### 必要な情報の準備
- Discord Bot Token
- AWS Access Key ID
- AWS Secret Access Key
- AWS Region（例：ap-northeast-1）

## 初期セットアップ

### 1. EC2環境の準備
```bash
# パッケージマネージャの更新とPythonのインストール
sudo yum update -y
sudo yum install -y python3-pip python3-devel
```

### 2. GitHubからのクローン
```bash
# ホームディレクトリに移動
cd ~

# 既存のディレクトリがある場合は削除
rm -rf discord-bot

# リポジトリのクローン
git clone https://github.com/tenchan000517/discord-bot.git
cd discord-bot
```

### 3. Python仮想環境のセットアップ
```bash
# 仮想環境の作成
python3 -m venv venv

# 仮想環境の有効化
source venv/bin/activate

# pipのアップグレード
python3 -m pip install --upgrade pip

# 必要なパッケージのインストール
pip install discord.py python-dotenv boto3 pytz
```

### 4. 環境変数の設定
```bash
# .envファイルの作成
nano .env
```

.envファイルの内容：
```
DISCORD_BOT_TOKEN=your-bot-token
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_DEFAULT_REGION=ap-northeast-1
```

## デプロイ手順

### 1. systemdサービスの設定
```bash
# サービスファイルの作成
sudo nano /etc/systemd/system/discord-bot.service
```

サービスファイルの内容：
```ini
[Unit]
Description=Discord Bot Service
After=network.target
Wants=network.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
WorkingDirectory=/home/ec2-user/discord-bot
Environment=PYTHONUNBUFFERED=1
EnvironmentFile=/home/ec2-user/discord-bot/.env

ExecStart=/home/ec2-user/discord-bot/venv/bin/python main.py

Restart=always
RestartSec=10
StandardOutput=append:/var/log/discord-bot/discord.log
StandardError=append:/var/log/discord-bot/discord.error.log

# ログディレクトリの作成
PermissionsStartOnly=true
ExecStartPre=/bin/mkdir -p /var/log/discord-bot
ExecStartPre=/bin/chown ec2-user:ec2-user /var/log/discord-bot
ExecStartPre=/bin/chmod 755 /var/log/discord-bot

[Install]
WantedBy=multi-user.target
```

### 2. ログディレクトリの設定
```bash
sudo mkdir -p /var/log/discord-bot
sudo chown ec2-user:ec2-user /var/log/discord-bot
sudo chmod 755 /var/log/discord-bot
```

### 3. サービスの有効化と起動
```bash
sudo systemctl daemon-reload
sudo systemctl enable discord-bot
sudo systemctl start discord-bot
```

### 4. 動作確認
```bash
# サービスのステータス確認
sudo systemctl status discord-bot

# ログの確認
tail -f /var/log/discord-bot/discord.log
```

## メンテナンス手順

### 日常的なメンテナンス
1. ログの確認
```bash
# 通常ログの確認
tail -f /var/log/discord-bot/discord.log

# エラーログの確認
tail -f /var/log/discord-bot/discord.error.log
```

2. サービスの状態確認
```bash
sudo systemctl status discord-bot
```

### コードの更新手順
1. GitHubからの更新取得
```bash
cd ~/discord-bot
git pull origin main
```

2. 必要に応じて依存関係の更新
```bash
source venv/bin/activate
pip install -r requirements.txt
```

3. サービスの再起動
```bash
sudo systemctl restart discord-bot
```

### バックアップとリストア
1. 環境変数のバックアップ
```bash
cp .env .env.backup
```

2. ログのローテーション（必要に応じて）
```bash
sudo logrotate -f /etc/logrotate.d/discord-bot
```

## トラブルシューティング

### 一般的な問題と解決方法

1. サービスが起動しない場合
```bash
# エラーログの確認
journalctl -xeu discord-bot.service

# 直接実行してエラーを確認
cd ~/discord-bot
source venv/bin/activate
python main.py
```

2. Discord接続の問題
- ボットトークンの確認
- ネットワーク接続の確認
- Discordの開発者ポータルでボットの設定確認

3. データベース接続の問題
- AWS認証情報の確認
- リージョン設定の確認
- AWSサービスの状態確認

### 重要なコマンド集

#### サービス管理
```bash
# サービスの起動
sudo systemctl start discord-bot

# サービスの停止
sudo systemctl stop discord-bot

# サービスの再起動
sudo systemctl restart discord-bot

# サービスの状態確認
sudo systemctl status discord-bot
```

#### ログ管理
```bash
# リアルタイムログ監視
tail -f /var/log/discord-bot/discord.log

# エラーログ確認
tail -f /var/log/discord-bot/discord.error.log

# システムログ確認
journalctl -u discord-bot
```

### 注意事項
- 環境変数（.env）ファイルは決して公開リポジトリにコミットしないこと
- システム再起動後も自動的にサービスが起動することを確認
- 定期的なログの確認とバックアップを推奨
- コード更新時は必ずテスト環境で確認してから本番環境に適用

このガイドは継続的に更新されます。新しい機能や変更がある場合は、このドキュメントも更新してください。