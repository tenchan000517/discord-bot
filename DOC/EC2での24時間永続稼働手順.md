# EC2でDiscordボットを24時間稼働させる手順書

## 目次
1. EC2インスタンスのセットアップ
2. サーバーの初期設定
3. Pythonとボット関連パッケージのインストール
4. ボットコードのデプロイ
5. システムサービスの設定
6. 監視とメンテナンス
7. トラブルシューティング

## 1. EC2インスタンスのセットアップ

### 1.1 インスタンスの作成
1. AWSマネジメントコンソールにログイン
2. EC2ダッシュボードから「インスタンスを起動」をクリック
3. 以下の設定で進める：
   - AMI: Ubuntu Server 22.04 LTS
   - インスタンスタイプ: t2.micro（フリーティア対象）
   - ストレージ: 8GB（デフォルト）
   - セキュリティグループ設定：
     - SSH (Port 22): あなたのIPアドレスのみ
   - キーペア: 新規作成し、安全な場所に保存

### 1.2 Elastic IP（固定IP）の割り当て
1. EC2ダッシュボードの「Elastic IP」セクションへ移動
2. 「Elastic IPアドレスの割り当て」をクリック
3. 割り当てられたIPを作成したインスタンスに関連付け

## 2. サーバーの初期設定

### 2.1 SSHでの接続
```bash
# Windowsの場合（PowerShell）
ssh -i path/to/your-key.pem ubuntu@your-elastic-ip

# Mac/Linuxの場合
chmod 400 path/to/your-key.pem
ssh -i path/to/your-key.pem ubuntu@your-elastic-ip
```

### 2.2 システムの更新
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git
```

## 3. Pythonとボット関連パッケージのインストール

### 3.1 Python環境のセットアップ
```bash
# Python関連パッケージのインストール
sudo apt install -y python3-pip python3-venv

# プロジェクトディレクトリの作成
mkdir ~/discord-bot
cd ~/discord-bot

# 仮想環境の作成と有効化
python3 -m venv venv
source venv/bin/activate
```

### 3.2 必要なパッケージのインストール
```bash
pip install discord.py python-dotenv
pip freeze > requirements.txt
```

## 4. ボットコードのデプロイ

### 4.1 環境変数の設定
```bash
nano ~/.env

# 以下の内容を追加
DISCORD_TOKEN=your_bot_token
# その他必要な環境変数
```

### 4.2 ボットコードの配置
```bash
nano ~/discord-bot/bot.py

# 以下の基本的なコードを配置
```
```python
import os
import discord
from discord.ext import commands
import logging
from dotenv import load_dotenv

# ログの設定
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    filename='bot.log',
    filemode='a'
)

# 環境変数の読み込み
load_dotenv()

# インテントの設定
intents = discord.Intents.default()
intents.message_content = True

# ボットの初期化
bot = commands.Bot(command_prefix='!', intents=intents)

@bot.event
async def on_ready():
    logging.info(f'{bot.user} has connected to Discord!')
    print(f'{bot.user} is ready!')

@bot.event
async def on_error(event, *args, **kwargs):
    logging.error(f'Error in {event}:', exc_info=True)

@bot.event
async def on_command_error(ctx, error):
    logging.error(f'Command error: {error}')

# ここに既存のボットコードを追加

bot.run(os.getenv('DISCORD_TOKEN'))
```

## 5. システムサービスの設定

### 5.1 サービスファイルの作成
```bash
sudo nano /etc/systemd/system/discord-bot.service

# 以下の内容を追加
[Unit]
Description=Discord Bot Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/discord-bot
Environment=PYTHONUNBUFFERED=1
ExecStart=/home/ubuntu/discord-bot/venv/bin/python3 bot.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 5.2 サービスの有効化と起動
```bash
# サービスの有効化
sudo systemctl enable discord-bot

# サービスの起動
sudo systemctl start discord-bot

# ステータスの確認
sudo systemctl status discord-bot
```

## 6. 監視とメンテナンス

### 6.1 ログの確認
```bash
# システムサービスのログを確認
sudo journalctl -u discord-bot -f

# ボットの独自ログを確認
tail -f ~/discord-bot/bot.log
```

### 6.2 定期的なメンテナンス作業
- システムアップデート
```bash
sudo apt update && sudo apt upgrade -y
```

- ディスク使用量の確認
```bash
df -h
```

- ログファイルの管理
```bash
# ログローテーションの設定
sudo nano /etc/logrotate.d/discord-bot

/home/ubuntu/discord-bot/bot.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 644 ubuntu ubuntu
}
```

## 7. トラブルシューティング

### 7.1 一般的な問題と解決方法

#### サービスが起動しない場合
1. ログの確認
```bash
sudo journalctl -u discord-bot -e
```

2. 権限の確認
```bash
ls -l /home/ubuntu/discord-bot
ls -l /home/ubuntu/discord-bot/bot.py
```

3. 環境変数の確認
```bash
sudo systemctl show discord-bot -p Environment
```

#### ボットが応答しない場合
1. インターネット接続の確認
```bash
ping 8.8.8.8
```

2. Discordの接続状態確認
```bash
tail -f ~/discord-bot/bot.log
```

### 7.2 サービスの再起動
```bash
sudo systemctl restart discord-bot
```

### 7.3 エラー時の対応手順
1. ログファイルの確認
2. 必要に応じてサービスの再起動
3. コードの変更が必要な場合は、変更後にサービスを再起動

## 注意事項
- セキュリティグループの設定は必要最小限に留める
- 環境変数やトークンは安全に管理する
- 定期的なバックアップを行う
- システムアップデートは定期的に実施する

## 補足：自動再起動の設定
EC2インスタンスが予期せず停止した場合の自動再起動を設定することを推奨します：

1. EC2ダッシュボードでインスタンスを選択
2. アクション → インスタンスの設定 → 詳細設定
3. 「停止動作の変更」で「停止/終了」を「停止」に設定
4. 「自動復旧の設定」を有効化