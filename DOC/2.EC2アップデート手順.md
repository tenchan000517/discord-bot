# Amazon LinuxでのDiscordボットセットアップ手順

## 1. システムの更新とPythonのセットアップ

```bash
# システムの更新
sudo yum update -y

# 開発ツールのインストール
sudo yum groupinstall "Development Tools" -y

# Pythonと関連パッケージのインストール
sudo yum install python3 python3-pip python3-devel -y
```

## 2. プロジェクトの準備

```bash
# プロジェクトディレクトリの作成
mkdir ~/discord-bot
cd ~/discord-bot

# Python仮想環境の作成
python3 -m venv venv

# 仮想環境の有効化
source venv/bin/activate

# 必要なパッケージのインストール
pip install discord.py python-dotenv

# 依存関係の保存
pip freeze > requirements.txt
```

## 3. ボットコードの作成と環境設定

```bash
# 環境変数ファイルの作成
nano ~/.env

# 以下の内容を追加して保存（Ctrl + X, Y, Enter）
DISCORD_TOKEN=your_bot_token_here
```

```bash
# ボットコードの作成
nano ~/discord-bot/bot.py

# 以下の内容を追加して保存（Ctrl + X, Y, Enter）
```

```python
import os
import discord
from discord.ext import commands
import logging
from dotenv import load_dotenv

# ログの設定
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    filename='bot.log',
    filemode='a'
)

# 環境変数の読み込み
load_dotenv()

# インテントの設定
intents = discord.Intents.default()
intents.message_content = True

# ボットの初期化
bot = commands.Bot(command_prefix='!', intents=intents)

@bot.event
async def on_ready():
    logging.info(f'{bot.user} has connected to Discord!')
    print(f'{bot.user} is ready!')

@bot.event
async def on_error(event, *args, **kwargs):
    logging.error(f'Error in {event}:', exc_info=True)

@bot.event
async def on_command_error(ctx, error):
    logging.error(f'Command error: {error}')

# ここに既存のボットコードを追加

bot.run(os.getenv('DISCORD_TOKEN'))
```

## 4. systemdサービスの設定

```bash
# サービスファイルの作成
sudo nano /etc/systemd/system/discord-bot.service

# 以下の内容を追加して保存（Ctrl + X, Y, Enter）
[Unit]
Description=Discord Bot Service
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/home/ec2-user/discord-bot
Environment=PYTHONUNBUFFERED=1
ExecStart=/home/ec2-user/discord-bot/venv/bin/python3 bot.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

## 5. サービスの起動と有効化

```bash
# サービスの有効化
sudo systemctl enable discord-bot

# サービスの起動
sudo systemctl start discord-bot

# ステータスの確認
sudo systemctl status discord-bot
```

## 6. ログの確認方法

```bash
# システムサービスのログを確認
sudo journalctl -u discord-bot -f

# ボットの独自ログを確認
tail -f ~/discord-bot/bot.log
```

## 7. よく使うコマンド

### サービスの管理
```bash
# サービスの停止
sudo systemctl stop discord-bot

# サービスの再起動
sudo systemctl restart discord-bot

# サービスの状態確認
sudo systemctl status discord-bot
```

### ログの管理
```bash
# 最新のログを確認
tail -f ~/discord-bot/bot.log

# システムログの確認
sudo journalctl -u discord-bot -f --since today
```

## トラブルシューティング

### サービスが起動しない場合
1. ログの確認
```bash
sudo journalctl -u discord-bot -e
```

2. 権限の確認
```bash
ls -l ~/discord-bot
ls -l ~/discord-bot/bot.py
```

3. 仮想環境のPythonパスの確認
```bash
which python3
echo $PATH
```

4. 環境変数ファイルの確認
```bash
cat ~/.env
```

### ボットが応答しない場合
1. インターネット接続の確認
```bash
ping 8.8.8.8
```

2. Discordトークンの確認
```bash
nano ~/.env
```

3. ログの確認
```bash
tail -f ~/discord-bot/bot.log
```

## 重要な注意点

1. セキュリティ
- `.env`ファイルのパーミッション設定を適切に行う
```bash
chmod 600 ~/.env
```

2. バックアップ
- 定期的にコードのバックアップを取る
- ログファイルの定期的な整理を行う

3. メンテナンス
- 定期的にシステムの更新を行う
```bash
sudo yum update -y
```