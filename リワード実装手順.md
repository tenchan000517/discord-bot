# Discord Botポイント消費システム - 残り実装タスク

## 1. contracts/ ディレクトリのセットアップ
```bash
mkdir contracts
cd contracts

# ABI定義ファイルを作成
touch token_abi.json
touch nft_abi.json
```

token_abi.json の中身:
```json
{
  "abi": [
    {
      "inputs": [
        {
          "name": "recipient",
          "type": "address"
        },
        {
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "transfer",
      "outputs": [
        {
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ]
}
```

nft_abi.json の中身:
```json
{
  "abi": [
    {
      "inputs": [
        {
          "name": "to",
          "type": "address"
        },
        {
          "name": "tokenId",
          "type": "uint256"
        }
      ],
      "name": "mint",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ]
}
```

## 2. .env ファイルの追加設定
既存の .env に追加:
```bash
# Web3設定
WEB3_RPC_URL=https://your-rpc-url.infura.io/v3/PROJECT_ID
WEB3_PRIVATE_KEY=your_private_key_here
NFT_CONTRACT_ADDRESS=0x...  # デプロイ済みのNFTコントラクトアドレス
TOKEN_CONTRACT_ADDRESS=0x...  # デプロイ済みのトークンコントラクトアドレス

# クーポンAPI設定
COUPON_API_KEY=your_api_key_here
COUPON_API_URL=https://api.coupon-service.com/v1

# 報酬設定
REWARD_MIN_POINTS_COUPON=100
REWARD_MAX_POINTS_COUPON=1000
REWARD_MIN_POINTS_NFT=1000
REWARD_MIN_POINTS_TOKEN=500
TOKEN_CONVERSION_RATE=0.1
```

## 3. バッチ処理の実装
`batch/process_pending_rewards.py` を作成:
```python
import asyncio
from bot import bot

async def process_pending_rewards():
    """未処理の報酬を処理"""
    pending_rewards = await bot.reward_manager.get_pending_rewards()
    for reward in pending_rewards:
        await bot.reward_manager.process_reward(reward)

if __name__ == "__main__":
    asyncio.run(process_pending_rewards())
```

## 4. cronタスクの設定
```bash
# /etc/cron.d/discord-bot
*/5 * * * * cd /path/to/discord-gacha-bot && python batch/process_pending_rewards.py
```

## 5. デプロイパッケージの準備
requirements.txt に追加:
```
web3==6.11.1
aiohttp==3.8.5
boto3==1.28.44
```

## 6. デプロイ手順
```bash
# 1. 依存パッケージのインストール
pip install -r requirements.txt

# 2. 環境変数の設定確認
python -c "import os; print(os.getenv('WEB3_RPC_URL'))"
python -c "import os; print(os.getenv('NFT_CONTRACT_ADDRESS'))"
python -c "import os; print(os.getenv('TOKEN_CONTRACT_ADDRESS'))"

# 3. Botの起動
python main.py
```

以上の実装で:
- Web3連携（NFT、トークン）
- クーポンAPI連携
- バッチ処理
- デプロイ設定

が完了し、システムが本番稼働できる状態になります。